// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ROLE {
  ADMIN
  USER
  MODERATOR
}

enum CategoriaEstoqueEnum {
  DEFENSIVOS
  FERTILIZANTES
  SEMENTES
  CONDICIONADORES
  FERRAMENTAS
  EQUIPAMENTOS
  EMBALAGENS
}

enum StatusEstoqueEnum {
  DISPONIVEL
  EM_USO
  ESGOTADO
  DANIFICADO
  EXPIRADO
}

enum UnidadeMedidaEnum {
  QUILO
  GRAMA
  LITRO
  METRO
  CENTIMETRO
  METRO_QUADRADO
  METRO_CUBICO
  TONELADA
}

enum TipoPlantaEnum {
  SOJA
  MILHO
  FEIJAO
  ARROZ
  CAFE
  ALGODAO
  BANANA
  LARANJA
}

enum TipoSoloEnum {
  ARENOSO
  ARGILOSO
  SILTOSO
  MISTO
  HUMIFERO
  CALCARIO
  GLEISSOLO
  LATOSSOLO
  CAMBISSOLO
  ORGANOSSOLO
  NEOSSOLO
  PLANOSSOLO
  VERTISSOLO
}

enum StatusPlantioEnum {
  PLANEJADO
  EXECUTADO
  EM_MONITORAMENTO
  CONCLUIDO
}

enum UnidadeDoseEnum {
  KG_HA // Quilogramas por hectare
  G_HA // Gramas por hectare
  ML_HA // Mililitros por hectare
  L_HA // Litros por hectare
  TON_HA // Toneladas por hectare
}

enum TipoOperacaoEnum {
  CREATE // Criação de registro
  UPDATE // Atualização de registro
  DELETE // Exclusão de registro
  DEACTIVATE // Desativação de registro
  ACTIVATE // Ativação de registro
  READ // Leitura de registro
}

// Etapas do plantio conforme boas práticas (preparo → semeadura → aplicações → colheita)
enum TipoEtapaOperacaoEnum {
  PREPARO_SOLO
  SEMEADURA
  APLICACAO_DEFENSIVO
  APLICACAO_FERTILIZANTE
  IRRIGACAO
  COLHEITA
  OUTROS
}

// Tipo de aplicação (defensivo ou fertilizante) para dose por ha e rastreabilidade
enum TipoAplicacaoEnum {
  DEFENSIVO
  FERTILIZANTE
}

enum TipoPlanoEnum {
  BASICO
  PRO
  PREMIUM
}

enum StatusPagamentoEnum {
  CANCELADO
  APROVADO
  REPROVADO
  PROCESSANDO
}

enum FormaPagamentoEnum {
  PIX
  CARTAO_CREDITO
  BOLETO
}

enum StatusCobrancaEnum {
  PENDENTE
  PAGO
  CANCELADO
  VENCIDO
}

model Plano {
  id                   Int       @id @default(autoincrement())
  nome                 String    
  tempoPlanoDias       Int?      @map("tempo_plano_dias")
  tipoPlano            TipoPlanoEnum @map("tipo_plano")
  valorPlano           Float     @map("valor_plano") // valor para o período em dias (tempoPlanoDias)
  descricao            String?
  ativo                Boolean   @default(true)
  createdBy            String?   @map("created_by") @db.VarChar(255)
  dateCreated          DateTime  @default(now()) @map("date_created") @db.Timestamp(0)
  dateModified         DateTime  @updatedAt @map("date_modified") @db.Timestamp(0)
  modifiedBy           String?   @map("modified_by") @db.VarChar(255)

  usuarios       Usuario[]       @relation("UsuarioPlanoAtual")
  usuarioPlanos  UsuarioPlano[]

  @@map("plano")
}

model UsuarioPlano {
  id                   Int       @id @default(autoincrement())
  idPlano              Int       @map("id_plano")
  idUsuario            Int       @map("id_usuario")
  dataInicioPlano      DateTime  @default(now()) @map("data_inicio_plano") @db.Timestamp(0)
  dataFimPlano         DateTime  @map("data_fim_plano") @db.Timestamp(0)
  dataCanceladoEm      DateTime? @map("cancelado_em") @db.Timestamp(0)
  motivoCancelamento   String?   @map("motivo_cancelamento") @db.VarChar(255)
  renovacaoAutomatica  Boolean   @default(true) @map("renovacao_automatica")
  ativo                Boolean   @default(true)
  createdBy            String?   @map("created_by") @db.VarChar(255)
  dateCreated          DateTime  @default(now()) @map("date_created") @db.Timestamp(0)
  dateModified         DateTime  @updatedAt @map("date_modified") @db.Timestamp(0)
  modifiedBy           String?   @map("modified_by") @db.VarChar(255)

  plano       Plano            @relation(fields: [idPlano], references: [id], onDelete: Restrict)
  usuario     Usuario          @relation(fields: [idUsuario], references: [id], onDelete: Cascade)
  pagamentos  PagamentoPlano[]
  cobrancas   Cobranca[]

  @@map("usuario_plano")
}

model PagamentoPlano {
  id                   Int       @id @default(autoincrement())
  idUsuarioPlano       Int       @map("id_usuario_plano")
  dataPagamento        DateTime  @default(now()) @map("data_pagamento") @db.Timestamp(0)
  dataVencimento       DateTime? @map("data_vencimento") @db.Timestamp(0)
  valor                Float?    @map("valor")
  statusPagamento      StatusPagamentoEnum @map("status_pagamento")
  formaPagamento       FormaPagamentoEnum? @map("forma_pagamento")
  idTransacaoExterno   String?   @map("id_transacao_externo") @db.VarChar(255)
  ativo                Boolean   @default(true)
  createdBy            String?   @map("created_by") @db.VarChar(255)
  dateCreated          DateTime  @default(now()) @map("date_created") @db.Timestamp(0)
  dateModified         DateTime  @updatedAt @map("date_modified") @db.Timestamp(0)
  modifiedBy           String?   @map("modified_by") @db.VarChar(255)

  usuarioPlano UsuarioPlano @relation(fields: [idUsuarioPlano], references: [id], onDelete: Cascade)
  cobranca     Cobranca?   @relation("CobrancaPagamento")

  @@map("pagamento_plano")
}

model Cobranca {
  id                   Int                 @id @default(autoincrement())
  idUsuarioPlano       Int                 @map("id_usuario_plano")
  formaPagamento       FormaPagamentoEnum   @map("forma_pagamento")
  valor                Float                @map("valor")
  dataVencimento       DateTime            @map("data_vencimento") @db.Timestamp(0)
  codigoCobranca       String               @unique @map("codigo_cobranca") @db.VarChar(64)
  status               StatusCobrancaEnum   @default(PENDENTE) @map("status")
  idPagamentoPlano     Int?                 @unique @map("id_pagamento_plano")
  createdBy            String?              @map("created_by") @db.VarChar(255)
  dateCreated          DateTime            @default(now()) @map("date_created") @db.Timestamp(0)
  dateModified         DateTime            @updatedAt @map("date_modified") @db.Timestamp(0)
  modifiedBy           String?              @map("modified_by") @db.VarChar(255)

  usuarioPlano   UsuarioPlano    @relation(fields: [idUsuarioPlano], references: [id], onDelete: Cascade)
  pagamentoPlano PagamentoPlano? @relation("CobrancaPagamento", fields: [idPagamentoPlano], references: [id], onDelete: SetNull)

  @@map("cobranca")
}

model Usuario {
  id                   Int       @id @default(autoincrement())
  password             String    @db.VarChar(100)
  resetPasswordToken   String?   @map("reset_password_token")
  resetPasswordExpires DateTime? @map("reset_password_expires")
  role                 ROLE      @default(USER)
  email                String    @unique @db.VarChar(100)
  idPlano              Int?      @map("id_plano")
  cpf                  String?   @unique @db.Char(11)
  nome                 String    @db.VarChar(100)
  telefone             String?   @db.VarChar(14)
  ativo                Boolean   @default(true)
  createdBy            String?   @map("created_by") @db.VarChar(255)
  dateCreated          DateTime  @default(now()) @map("date_created") @db.Timestamp(0)
  dateModified         DateTime  @updatedAt @map("date_modified") @db.Timestamp(0)
  modifiedBy           String?   @map("modified_by") @db.VarChar(255)

  plano         Plano?          @relation("UsuarioPlanoAtual", fields: [idPlano], references: [id], onDelete: SetNull)
  usuarioPlanos UsuarioPlano[]
  fazendas      Fazenda[]
  fornecedores  Fornecedor[]
  cultivares    Cultivar[]
  analisesSolo  AnaliseSolo[]
  logs          Log[]

  @@map("usuario")
}

model Fazenda {
  id                  Int      @id @default(autoincrement())
  nome                String   @db.VarChar(255)
  latitude            Float
  longitude           Float
  areaTotal           Float?   @map("area_total")
  cnpj                String?  @unique @db.VarChar(14)
  soloPredominante    String?  @map("solo_predominante") @db.VarChar(255)
  cultivoPredominante String?  @map("cultivo_predominante") @db.VarChar(255)
  municipio           String?  @db.VarChar(255)
  uf                  String?  @db.VarChar(2)
  idUsuario           Int      @map("id_usuario")
  ativo               Boolean  @default(true)
  createdBy           String?  @map("created_by") @db.VarChar(255)
  dateCreated         DateTime @default(now()) @map("date_created")
  dateModified        DateTime @updatedAt @map("date_modified")
  modifiedBy          String?  @map("modified_by") @db.VarChar(255)

  usuario         Usuario           @relation(fields: [idUsuario], references: [id])
  produtosEstoque ProdutosEstoque[]
  plantios        Plantio[]
  talhoes         Talhao[]

  @@map("fazenda")
}

// Talhão: parcela de terra da fazenda (base para custo, rotação e mapa)
model Talhao {
  id          Int      @id @default(autoincrement())
  idFazenda   Int      @map("id_fazenda")
  nome        String   @db.VarChar(255)
  areaHa      Float    @map("area_ha") // área em hectares (cadastro ou cálculo)
  observacao  String?  @db.VarChar(500)
  ativo       Boolean  @default(true)
  createdBy   String?  @map("created_by") @db.VarChar(255)
  dateCreated DateTime @default(now()) @map("date_created")
  dateModified DateTime @updatedAt @map("date_modified")
  modifiedBy  String?  @map("modified_by") @db.VarChar(255)

  fazenda   Fazenda   @relation(fields: [idFazenda], references: [id], onDelete: Cascade)
  plantios  Plantio[]
  operacoes OperacaoPlantio[]

  @@map("talhao")
}

model ProdutosEstoque {
  id            Int                  @id @default(autoincrement())
  descricao     String?
  marca         String?
  nome          String?
  quantidade    Int                  @default(0)
  valorUnitario Float                @default(0.0) @map("valor_unitario")
  unidadeMedida UnidadeMedidaEnum    @map("unidade_medida")
  dataValidade  DateTime?            @map("data_validade")
  categoria     CategoriaEstoqueEnum
  status        StatusEstoqueEnum
  idFazenda     Int                  @map("id_fazenda")
  idFornecedor  Int                  @map("id_fornecedor")
  ativo         Boolean              @default(true)
  createdBy     String?              @map("created_by") @db.VarChar(255)
  dateCreated   DateTime             @default(now()) @map("date_created")
  dateModified  DateTime             @updatedAt @map("date_modified")
  modifiedBy    String?              @map("modified_by") @db.VarChar(255)

  fazenda    Fazenda    @relation(fields: [idFazenda], references: [id])
  fornecedor Fornecedor @relation(fields: [idFornecedor], references: [id])
  aplicacoes Aplicacao[]

  @@map("produtos_estoque")
}

model Fornecedor {
  id           Int      @id @default(autoincrement())
  cnpj         String   @unique @db.VarChar(14)
  razaoSocial  String   @map("razao_social")
  nomeFantasia String?  @map("nome_fantasia")
  responsavel  String?
  email        String?
  telefone     String?
  linkSite     String?  @map("link_site")
  logradouro   String?
  numero       String?
  complemento  String?
  bairro       String?
  cidade       String?
  estado       String?
  cep          String?
  observacao   String?
  idUsuario    Int      @map("id_usuario")
  ativo        Boolean  @default(true)
  createdBy    String?  @map("created_by")
  dateCreated  DateTime @default(now()) @map("date_created")
  dateModified DateTime @updatedAt @map("date_modified")
  modifiedBy   String?  @map("modified_by")

  usuario         Usuario           @relation(fields: [idUsuario], references: [id])
  produtosEstoque ProdutosEstoque[]
  cultivares      Cultivar[]

  @@map("fornecedor")
}

model Praga {
  id             Int      @id @default(autoincrement())
  nomeCientifico String   @map("nome_cientifico") @db.VarChar(255)
  nomeComum      String   @map("nome_comum") @db.VarChar(255)
  descricao      String?
  dateCreated    DateTime @default(now()) @map("date_created")
  dateModified   DateTime @updatedAt @map("date_modified")
  createdBy      String?  @map("created_by")
  modifiedBy     String?  @map("modified_by")

  cultivares Cultivar[]

  @@map("praga")
}

model Cultivar {
  id                Int            @id @default(autoincrement())
  nomeCientifico    String?        @map("nome_cientifico") @db.VarChar(255)
  nomePopular       String         @map("nome_popular") @db.VarChar(255)
  tipoPlanta        TipoPlantaEnum @map("tipo_planta")
  tipoSolo          TipoSoloEnum   @map("tipo_solo")
  phSolo            Float?         @map("ph_solo")
  dataPlantioInicio DateTime?      @map("data_plantio_inicio")
  dataPlantioFim    DateTime?      @map("data_plantio_fim")
  periodoDias       Int?           @map("periodo_dias")
  mmAgua            Float?         @map("mm_agua")
  aduboNitrogenio   Float?         @map("adubo_nitrogenio")
  aduboFosforo      Float?         @map("adubo_fosforo")
  aduboPotassio     Float?         @map("adubo_potassio")
  aduboCalcio       Float?         @map("adubo_calcio")
  aduboMagnesio     Float?         @map("adubo_magnesio")
  tempoCicloDias    Int?           @map("tempo_ciclo_dias")
  densidadePlantio  Float?         @map("densidade_plantio")
  densidadeColheita Float?         @map("densidade_colheita")
  observacao        String?
  idUsuario         Int            @map("id_usuario")
  idPraga           Int?           @map("id_praga")
  idFornecedor      Int?           @map("id_fornecedor")
  createdBy         String?        @map("created_by")
  dateCreated       DateTime       @default(now()) @map("date_created")
  dateModified      DateTime?      @updatedAt @map("date_modified")
  modifiedBy        String?        @map("modified_by")

  usuario    Usuario     @relation(fields: [idUsuario], references: [id])
  praga      Praga?      @relation(fields: [idPraga], references: [id])
  fornecedor Fornecedor? @relation(fields: [idFornecedor], references: [id])
  plantios   Plantio[]

  @@map("cultivar")
}

model AnaliseSolo {
  id        Int @id @default(autoincrement())
  idUsuario Int @map("id_usuario")

  ph            Float? @map("ph")
  areaTotal     Float? @map("area_total")
  hAi           Float? @map("h_ai")
  sb            Float? @map("sb")
  ctc           Float? @map("ctc")
  v             Float? @map("v")
  m             Float? @map("m")
  mo            Float? @map("mo")
  prnt          Float? @map("prnt")
  valorCultural Float? @map("valor_cultural")
  n             Float? @map("n")
  p             Float? @map("p")
  k             Float? @map("k")

  ativo        Boolean  @default(true)
  createdBy    String?  @map("created_by") @db.VarChar(255)
  dateCreated  DateTime @default(now()) @map("date_created")
  dateModified DateTime @updatedAt @map("date_modified")
  modifiedBy   String?  @map("modified_by") @db.VarChar(255)

  usuario  Usuario   @relation(fields: [idUsuario], references: [id])
  plantios Plantio[]

  @@map("analise_solo")
}

model Plantio {
  id            Int   @id @default(autoincrement())
  idCultivar    Int   @map("id_cultivar")
  idFazenda     Int   @map("id_fazenda")
  idTalhao      Int?  @map("id_talhao") // opcional: plantio pode ser por talhão
  idAnaliseSolo Int?  @map("id_analise_solo")

  dataPlantio          DateTime  @map("data_plantio")
  dataEmergencia       DateTime? @map("data_emergencia")
  dataPrevistaColheita DateTime? @map("data_prevista_colheita")
  dataMaturacao        DateTime? @map("data_maturacao")

  areaPlantada         Float @map("area_plantada") // hectares
  densidadePlanejada   Float @map("densidade_planejada") // plantas/ha planejadas
  densidadePlantioReal Float @map("densidade_plantio_real") // plantas/ha efetivas

  phSoloInicial      Float? @map("ph_solo_inicial") // pH antes do plantio
  umidadeSoloInicial Float? @map("umidade_solo_inicial") // % de umidade ao plantar

  loteSemente       String? @map("lote_semente") // código do lote de semente
  taxaGerminacao    Float?  @map("taxa_germinacao") // % de germinação
  tratamentoSemente String? @map("tratamento_semente") // fungicida, inoculante etc

  profundidadeSemeadura  Float?  @map("profundidade_semeadura") // cm
  espacamentoEntreLinhas Float?  @map("espacamento_entre_linhas") // cm
  orientacaoTransplantio String? @map("orientacao_transplantio") // N-S, L-O etc

  mmAguaAplicado   Float  @map("mm_agua_aplicado") // lâmina de água aplicada (mm)
  irrigacaoVolume  Float? @map("irrigacao_volume") // volume irrigado (mm)
  irrigacaoDuracao Int?   @map("irrigacao_duracao") // duração da irrigação (minutos)

  aduboNitrogenioDose    Float?           @map("adubo_nitrogenio_dose")
  aduboNitrogenioUnidade UnidadeDoseEnum? @map("adubo_nitrogenio_unidade")
  aduboFosforoDose       Float?           @map("adubo_fosforo_dose")
  aduboFosforoUnidade    UnidadeDoseEnum? @map("adubo_fosforo_unidade")
  aduboPotassioDose      Float?           @map("adubo_potassio_dose")
  aduboPotassioUnidade   UnidadeDoseEnum? @map("adubo_potassio_unidade")

  defensivoUtilizado String?          @map("defensivo_utilizado")
  doseDefensivo      Float?           @map("dose_defensivo")
  unidadeDefensivo   UnidadeDoseEnum? @map("unidade_defensivo")

  rendimentoEstimado Float? @map("rendimento_estimado") // kg/ha

  custoSemente      Float? @map("custo_semente") // R$/ha
  custoFertilizante Float? @map("custo_fertilizante") // R$/ha
  custoDefensivo    Float? @map("custo_defensivo") // R$/ha
  custoCombustivel  Float? @map("custo_combustivel") // R$
  custoOutros       Float? @map("custo_outros") // R$
  custoTotal        Float? @map("custo_total") // R$

  statusPlantio StatusPlantioEnum @default(PLANEJADO) @map("status_plantio")

  observacao String? @map("observacao")
  ativo      Boolean @default(true)

  createdBy    String?  @map("created_by") @db.VarChar(255)
  dateCreated  DateTime @default(now()) @map("date_created")
  dateModified DateTime @updatedAt @map("date_modified")
  modifiedBy   String?  @map("modified_by") @db.VarChar(255)

  cultivar    Cultivar     @relation(fields: [idCultivar], references: [id], onDelete: Restrict)
  fazenda     Fazenda      @relation(fields: [idFazenda], references: [id], onDelete: Restrict)
  talhao      Talhao?      @relation(fields: [idTalhao], references: [id], onDelete: SetNull)
  analiseSolo AnaliseSolo? @relation(fields: [idAnaliseSolo], references: [id], onDelete: Cascade)
  operacoes   OperacaoPlantio[]

  @@map("plantio")
}

// Operação/etapa do plantio (rastreabilidade e custo por operação)
model OperacaoPlantio {
  id           Int                   @id @default(autoincrement())
  idPlantio    Int                   @map("id_plantio")
  idTalhao     Int?                  @map("id_talhao") // quando a operação é por talhão
  tipoEtapa    TipoEtapaOperacaoEnum @map("tipo_etapa")
  dataInicio   DateTime              @map("data_inicio") @db.Date
  dataFim      DateTime?             @map("data_fim") @db.Date
  areaHa       Float                 @map("area_ha") // área em que a operação foi feita (ha)
  custoTotal   Float?                @map("custo_total") // R$
  custoPorHa   Float?                @map("custo_por_ha") // R$/ha = custoTotal / areaHa
  observacao   String?               @db.VarChar(500)
  ativo        Boolean               @default(true)
  createdBy    String?               @map("created_by") @db.VarChar(255)
  dateCreated  DateTime              @default(now()) @map("date_created")
  dateModified DateTime              @updatedAt @map("date_modified")
  modifiedBy   String?               @map("modified_by") @db.VarChar(255)

  plantio    Plantio    @relation(fields: [idPlantio], references: [id], onDelete: Cascade)
  talhao     Talhao?    @relation(fields: [idTalhao], references: [id], onDelete: SetNull)
  aplicacoes Aplicacao[]

  @@map("operacao_plantio")
}

// Aplicação de defensivo ou fertilizante (dose por ha → quantidade total)
model Aplicacao {
  id                    Int              @id @default(autoincrement())
  idOperacaoPlantio     Int              @map("id_operacao_plantio")
  idProdutosEstoque     Int?             @map("id_produtos_estoque")
  tipo                  TipoAplicacaoEnum
  nomeProduto           String?          @map("nome_produto") @db.VarChar(255) // quando não vincula estoque
  dosePorHa             Float            @map("dose_por_ha") // dose em unidade por hectare
  unidadeDose           UnidadeDoseEnum  @map("unidade_dose")
  quantidadeTotal       Float?           @map("quantidade_total") // dosePorHa * areaHa (cálculo agronômico)
  custoAplicacao        Float?           @map("custo_aplicacao") // R$
  dataAplicacao         DateTime         @map("data_aplicacao") @db.Date
  observacao            String?          @db.VarChar(500)
  ativo                 Boolean          @default(true)
  createdBy             String?          @map("created_by") @db.VarChar(255)
  dateCreated           DateTime         @default(now()) @map("date_created")
  dateModified          DateTime         @updatedAt @map("date_modified")
  modifiedBy            String?          @map("modified_by") @db.VarChar(255)

  operacaoPlantio OperacaoPlantio @relation(fields: [idOperacaoPlantio], references: [id], onDelete: Cascade)
  produtoEstoque  ProdutosEstoque? @relation(fields: [idProdutosEstoque], references: [id], onDelete: SetNull)

  @@map("aplicacao")
}

model Log {
  id              Int              @id @default(autoincrement())
  tipoOperacao    TipoOperacaoEnum @map("tipo_operacao")
  tabela          String           @db.VarChar(100)
  idRegistro      Int?             @map("id_registro")
  dadosAnteriores Json?            @map("dados_anteriores")
  dadosNovos      Json?            @map("dados_novos")
  descricao       String?          @db.Text
  idUsuario       Int?             @map("id_usuario")
  emailUsuario    String?          @map("email_usuario") @db.VarChar(255)
  ipAddress       String?          @map("ip_address") @db.VarChar(45)
  userAgent       String?          @map("user_agent") @db.VarChar(500)
  dateCreated     DateTime         @default(now()) @map("date_created") @db.Timestamp(0)

  usuario Usuario? @relation(fields: [idUsuario], references: [id], onDelete: SetNull)

  @@index([tabela])
  @@index([idRegistro])
  @@index([tipoOperacao])
  @@index([idUsuario])
  @@index([dateCreated])
  @@map("log")
}
